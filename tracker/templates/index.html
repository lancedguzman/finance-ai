{% extends 'base.html' %}

{% block content %}
<div id="app" v-cloak>
    <div class="container">
        
        <div class="header-section" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>Financial Dashboard</h1>
                <p style="color: var(--accent-brown);">Overview for Year [[ filterKey ]]</p>
            </div>
            
            <div>
                <select v-model="filterKey" style="padding: 10px 15px; border-radius: 8px; border: 1px solid #ccc; font-size: 1.1rem; font-weight: bold; color: var(--navy-contrast); cursor: pointer; background-color: white;">
                    <option v-for="year in yearOptions" :value="year">
                        Year [[ year ]]
                    </option>
                </select>
            </div>
        </div>

        <div class="cards-grid">
            <div class="card card-balance">
                <h3>Total Balance ([[ filterKey ]])</h3>
                <div class="amount">[[ formatCurrency(yearlyBalance) ]]</div>
            </div>
            <div class="card card-income">
                <h3 style="color: var(--text-green)">Total Income</h3>
                <div class="amount" style="color: var(--text-green)">+[[ formatCurrency(yearlyIncome) ]]</div>
            </div>
            <div class="card card-expense">
                <h3>Total Expenses</h3>
                <div class="amount" style="color: var(--alert-red)">-[[ formatCurrency(yearlyExpense) ]]</div>
            </div>
            <div class="card card-savings">
                <h3 style="color: var(--accent-brown)">Savings Goal (40%)</h3>
                <div class="amount" style="color: var(--accent-brown)">
                    [[ formatCurrency(yearlySavings) ]] / [[ formatCurrency(savingsGoal) ]]
                </div>
            </div>
        </div>

        <div class="charts-section" style="margin-bottom: 2rem;">
            
            <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                <div class="card" style="min-height: 350px;">
                    <h3 style="margin-bottom: 1rem; text-align: center;">Income vs. Expense</h3>
                    <div style="position: relative; height: 280px;">
                        <canvas id="incomeExpenseChart"></canvas>
                    </div>
                </div>

                <div class="card" style="min-height: 350px;">
                    <h3 style="margin-bottom: 1rem; text-align: center;">Expense by Category</h3>
                    <div style="position: relative; height: 280px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                
                <div class="card" style="min-height: 350px;">
                    <h3 style="margin-bottom: 1rem; text-align: center;">Monthly Summary</h3>
                    <div style="position: relative; height: 280px;">
                        <canvas id="monthlySummaryChart"></canvas>
                    </div>
                </div>

                <div class="card" style="min-height: 350px;">
                    <h3 style="margin-bottom: 1rem; text-align: center;">Highest Expense / Month</h3>
                    <div style="position: relative; height: 280px;">
                        <canvas id="highestExpenseChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 1rem;">Monthly Trend ([[ filterKey ]])</h3>
                <div style="position: relative; height: 350px; width: 100%;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const { createApp } = Vue;

    createApp({
        delimiters: ['[[', ']]'],
        data() {
            const currentYear = new Date().getFullYear().toString();

            return {
                filterKey: currentYear, 
                transactions: [],
                categories: {{ categories|safe }},
                
                chartInstances: {
                    incomeExpense: null,
                    category: null,
                    trend: null,
                    monthlySummary: null,   // New
                    highestExpense: null    // New
                }
            }
        },
        computed: {
            yearOptions() {
                const years = new Set();
                years.add(new Date().getFullYear().toString());
                
                this.transactions.forEach(t => {
                    const y = t.date.split('-')[0];
                    years.add(y);
                });
                return Array.from(years).sort().reverse();
            },

            filteredTransactions() {
                return this.transactions.filter(t => t.date.startsWith(this.filterKey));
            },

            yearlyIncome() {
                return this.filteredTransactions.filter(t => t.type === 'INCOME').reduce((sum, t) => sum + t.amount, 0);
            },
            yearlyExpense() {
                return this.filteredTransactions.filter(t => t.type === 'EXPENSE').reduce((sum, t) => sum + t.amount, 0);
            },
            yearlyBalance() {
                return this.yearlyIncome - this.yearlyExpense;
            },
            savingsGoal() {
                return this.yearlyIncome * 0.40;
            },
            yearlySavings() {
                const savings = this.yearlyIncome - this.yearlyExpense;
                return savings > 0 ? savings : 0;
            }
        },
        watch: {
            filteredTransactions: {
                handler() {
                    this.$nextTick(() => {
                        this.renderCharts();
                    });
                },
                deep: true
            }
        },
        methods: {
            formatCurrency(value) {
                return 'â‚±' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            },
            
            renderCharts() {
                this.renderIncomeVsExpense();
                this.renderCategoryChart();
                this.renderMonthlySummary();   // New
                this.renderHighestExpense();   // New
                this.renderTrendChart();
            },

            renderIncomeVsExpense() {
                const ctx = document.getElementById('incomeExpenseChart');
                if (!ctx) return;
                
                if (this.chartInstances.incomeExpense) this.chartInstances.incomeExpense.destroy();

                this.chartInstances.incomeExpense = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Income', 'Expense'],
                        datasets: [{
                            data: [this.yearlyIncome, this.yearlyExpense],
                            backgroundColor: ['#2E865F', '#FF0000'], 
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            },

            renderCategoryChart() {
                const ctx = document.getElementById('categoryChart');
                if (!ctx) return;
                if (this.chartInstances.category) this.chartInstances.category.destroy();

                const expenses = this.filteredTransactions.filter(t => t.type === 'EXPENSE');
                const categoryTotals = {};
                
                expenses.forEach(t => {
                    categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                });

                this.chartInstances.category = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(categoryTotals),
                        datasets: [{
                            data: Object.values(categoryTotals),
                            backgroundColor: ['#288cfa', '#8d6e63', '#e0e0e0', '#f0ad4e', '#5bc0de', '#003366'],
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            },

            // --- NEW: Summary per month (Income, Expense, Savings) ---
            renderMonthlySummary() {
                const ctx = document.getElementById('monthlySummaryChart');
                if (!ctx) return;
                if (this.chartInstances.monthlySummary) this.chartInstances.monthlySummary.destroy();

                const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const incomeData = new Array(12).fill(0);
                const expenseData = new Array(12).fill(0);

                this.filteredTransactions.forEach(t => {
                    const monthIndex = parseInt(t.date.split('-')[1]) - 1;
                    if (t.type === 'INCOME') incomeData[monthIndex] += t.amount;
                    else expenseData[monthIndex] += t.amount;
                });

                // Calculate Savings (Income - Expense)
                const savingsData = incomeData.map((inc, i) => {
                    const val = inc - expenseData[i];
                    return val > 0 ? val : 0; // Show 0 if negative savings (deficit), or remove check to show deficit
                });

                this.chartInstances.monthlySummary = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Income',
                                data: incomeData,
                                backgroundColor: '#2E865F'
                            },
                            {
                                label: 'Expense',
                                data: expenseData,
                                backgroundColor: '#FF0000'
                            },
                            {
                                label: 'Savings',
                                data: savingsData,
                                backgroundColor: '#8d6e63'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            },

            // --- NEW: Highest Expense Category per Month ---
            renderHighestExpense() {
                const ctx = document.getElementById('highestExpenseChart');
                if (!ctx) return;
                if (this.chartInstances.highestExpense) this.chartInstances.highestExpense.destroy();

                const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // Track max expense and its category name per month
                // Structure: [{ max: 0, category: '' }, { max: 0, category: '' } ...]
                const monthlyMax = Array.from({ length: 12 }, () => ({ max: 0, category: 'N/A' }));
                
                // Helper to aggregate expenses per month first
                const monthlyCategoryTotals = Array.from({ length: 12 }, () => ({}));

                // 1. Sum up expenses by category per month
                this.filteredTransactions.forEach(t => {
                    if (t.type === 'EXPENSE') {
                        const monthIndex = parseInt(t.date.split('-')[1]) - 1;
                        if (!monthlyCategoryTotals[monthIndex][t.category]) {
                            monthlyCategoryTotals[monthIndex][t.category] = 0;
                        }
                        monthlyCategoryTotals[monthIndex][t.category] += t.amount;
                    }
                });

                // 2. Find max for each month
                monthlyCategoryTotals.forEach((categories, monthIndex) => {
                    let maxAmount = 0;
                    let maxCat = 'N/A';
                    
                    for (const [cat, amount] of Object.entries(categories)) {
                        if (amount > maxAmount) {
                            maxAmount = amount;
                            maxCat = cat;
                        }
                    }
                    monthlyMax[monthIndex] = { max: maxAmount, category: maxCat };
                });

                const dataValues = monthlyMax.map(m => m.max);
                const categoryLabels = monthlyMax.map(m => m.category);

                this.chartInstances.highestExpense = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Highest Expense Amount',
                            data: dataValues,
                            backgroundColor: '#288cfa'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    // Custom tooltip to show the Category Name
                                    afterLabel: function(context) {
                                        const index = context.dataIndex;
                                        return 'Category: ' + categoryLabels[index];
                                    }
                                }
                            }
                        },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            },

            renderTrendChart() {
                const ctx = document.getElementById('trendChart');
                if (!ctx) return;
                if (this.chartInstances.trend) this.chartInstances.trend.destroy();

                const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const incomeData = new Array(12).fill(0);
                const expenseData = new Array(12).fill(0);

                this.filteredTransactions.forEach(t => {
                    const monthIndex = parseInt(t.date.split('-')[1]) - 1; 
                    if (t.type === 'INCOME') incomeData[monthIndex] += t.amount;
                    else expenseData[monthIndex] += t.amount;
                });

                this.chartInstances.trend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Income',
                                data: incomeData,
                                borderColor: '#2E865F',
                                backgroundColor: 'rgba(46, 134, 95, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Expense',
                                data: expenseData,
                                borderColor: '#FF0000',
                                backgroundColor: 'rgba(255, 0, 0, 0.1)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true } }
                    }
                });
            },

            async fetchTransactions() {
                try {
                    const response = await fetch('/api/transactions/');
                    const data = await response.json();
                    this.transactions = data;
                } catch (error) { console.error("Error loading transactions:", error); }
            }
        },
        mounted() {
            this.fetchTransactions();
        }
    }).mount('#app');
</script>
{% endblock %}