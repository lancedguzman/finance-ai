{% extends 'base.html' %}

{% block content %}
<div id="app" v-cloak>
    <div class="container">
        
        <div class="header-section" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>Financial Dashboard</h1>
                <p style="color: var(--accent-brown);">Overview for Year [[ filterKey ]]</p>
            </div>
            
            <div>
                <select v-model="filterKey" style="padding: 10px 15px; border-radius: 8px; border: 1px solid #ccc; font-size: 1.1rem; font-weight: bold; color: var(--navy-contrast); cursor: pointer; background-color: white;">
                    <option v-for="year in yearOptions" :value="year">
                        Year [[ year ]]
                    </option>
                </select>
            </div>
        </div>

        <div class="cards-grid">
            <div class="card card-balance">
                <h3>Total Balance ([[ filterKey ]])</h3>
                <div class="amount">[[ formatCurrency(yearlyBalance) ]]</div>
            </div>
            <div class="card card-income">
                <h3 style="color: var(--text-green)">Total Income</h3>
                <div class="amount" style="color: var(--text-green)">+[[ formatCurrency(yearlyIncome) ]]</div>
            </div>
            <div class="card card-expense">
                <h3>Total Expenses</h3>
                <div class="amount" style="color: var(--alert-red)">-[[ formatCurrency(yearlyExpense) ]]</div>
            </div>
            <div class="card card-savings">
                <h3 style="color: var(--accent-brown)">Savings Goal (40%)</h3>
                <div class="amount" style="color: var(--accent-brown)">
                    [[ formatCurrency(yearlySavings) ]] / [[ formatCurrency(savingsGoal) ]]
                </div>
            </div>
        </div>

        <div class="charts-section" style="margin-bottom: 2rem;">
            <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                
                <div class="card" style="min-height: 350px;">
                    <h3 style="margin-bottom: 1rem; text-align: center;">Income vs. Expense</h3>
                    <div style="position: relative; height: 280px;">
                        <canvas id="incomeExpenseChart"></canvas>
                    </div>
                </div>

                <div class="card" style="min-height: 350px;">
                    <h3 style="margin-bottom: 1rem; text-align: center;">Expense by Category</h3>
                    <div style="position: relative; height: 280px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 1rem;">Monthly Trend ([[ filterKey ]])</h3>
                <div style="position: relative; height: 350px; width: 100%;">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const { createApp } = Vue;

    createApp({
        delimiters: ['[[', ']]'],
        data() {
            const currentYear = new Date().getFullYear().toString();

            return {
                filterKey: currentYear, // Now stores "YYYY"
                transactions: [],
                categories: {{ categories|safe }}, // Ensure views.py passes this!
                
                chartInstances: {
                    incomeExpense: null,
                    category: null,
                    trend: null
                }
            }
        },
        computed: {
            // 1. Generate Year Options (Current Year + any years found in data)
            yearOptions() {
                const years = new Set();
                years.add(new Date().getFullYear().toString()); // Always add current year
                
                this.transactions.forEach(t => {
                    const y = t.date.split('-')[0];
                    years.add(y);
                });
                
                // Sort descending (2025, 2024, 2023...)
                return Array.from(years).sort().reverse();
            },

            // 2. Filter Transactions by YEAR
            filteredTransactions() {
                // Returns transactions where date starts with "2025", etc.
                return this.transactions.filter(t => t.date.startsWith(this.filterKey));
            },

            // 3. Yearly Calculations
            yearlyIncome() {
                return this.filteredTransactions.filter(t => t.type === 'INCOME').reduce((sum, t) => sum + t.amount, 0);
            },
            yearlyExpense() {
                return this.filteredTransactions.filter(t => t.type === 'EXPENSE').reduce((sum, t) => sum + t.amount, 0);
            },
            yearlyBalance() {
                return this.yearlyIncome - this.yearlyExpense;
            },
            savingsGoal() {
                return this.yearlyIncome * 0.40;
            },
            yearlySavings() {
                const savings = this.yearlyIncome - this.yearlyExpense;
                return savings > 0 ? savings : 0;
            }
        },
        watch: {
            filteredTransactions: {
                handler() {
                    this.$nextTick(() => {
                        this.renderCharts();
                    });
                },
                deep: true
            }
        },
        methods: {
            formatCurrency(value) {
                return 'â‚±' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            },
            
            // --- CHART LOGIC ---
            renderCharts() {
                this.renderIncomeVsExpense();
                this.renderCategoryChart();
                this.renderTrendChart();
            },

            renderIncomeVsExpense() {
                const ctx = document.getElementById('incomeExpenseChart');
                if (!ctx) return;
                
                if (this.chartInstances.incomeExpense) this.chartInstances.incomeExpense.destroy();

                this.chartInstances.incomeExpense = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Income', 'Expense'],
                        datasets: [{
                            data: [this.yearlyIncome, this.yearlyExpense],
                            backgroundColor: ['#2E865F', '#FF0000'], 
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            },

            renderCategoryChart() {
                const ctx = document.getElementById('categoryChart');
                if (!ctx) return;
                if (this.chartInstances.category) this.chartInstances.category.destroy();

                const expenses = this.filteredTransactions.filter(t => t.type === 'EXPENSE');
                const categoryTotals = {};
                
                expenses.forEach(t => {
                    categoryTotals[t.category] = (categoryTotals[t.category] || 0) + t.amount;
                });

                this.chartInstances.category = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(categoryTotals),
                        datasets: [{
                            data: Object.values(categoryTotals),
                            backgroundColor: ['#288cfa', '#8d6e63', '#e0e0e0', '#f0ad4e', '#5bc0de', '#003366'],
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            },

            renderTrendChart() {
                const ctx = document.getElementById('trendChart');
                if (!ctx) return;
                if (this.chartInstances.trend) this.chartInstances.trend.destroy();

                // 1. Setup Labels for Months
                const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // 2. Initialize Data Buckets (12 zeros)
                const incomeData = new Array(12).fill(0);
                const expenseData = new Array(12).fill(0);

                // 3. Aggregate Data by Month
                this.filteredTransactions.forEach(t => {
                    // Extract month from "2025-05-20" -> "05" -> index 4
                    const monthIndex = parseInt(t.date.split('-')[1]) - 1; 
                    
                    if (t.type === 'INCOME') incomeData[monthIndex] += t.amount;
                    else expenseData[monthIndex] += t.amount;
                });

                this.chartInstances.trend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Income',
                                data: incomeData,
                                borderColor: '#2E865F',
                                backgroundColor: 'rgba(46, 134, 95, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Expense',
                                data: expenseData,
                                borderColor: '#FF0000',
                                backgroundColor: 'rgba(255, 0, 0, 0.1)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            },

            async fetchTransactions() {
                try {
                    const response = await fetch('/api/transactions/');
                    const data = await response.json();
                    this.transactions = data;
                } catch (error) { console.error("Error loading transactions:", error); }
            }
        },
        mounted() {
            this.fetchTransactions();
        }
    }).mount('#app');
</script>
{% endblock %}