{% extends 'base.html' %}

{% block content %}
<div id="app">
    <div class="container">
        
        <div class="header-section">
            <h1>Welcome Back, User</h1>
            <p style="color: var(--accent-brown);">Here is your financial overview for [[ targetMonth ]].</p>
        </div>

        <div class="cards-grid">
            <div class="card card-balance">
                <h3>Total Balance</h3>
                <div class="amount">₱12,450.00</div>
            </div>
            <div class="card card-income">
                <h3 style="color: var(--text-green)">Monthly Income</h3>
                <div class="amount" style="color: var(--text-green)">+₱4,200.00</div>
            </div>
            <div class="card card-expense">
                <h3>Monthly Expenses</h3>
                <div class="amount" style="color: var(--alert-red)">-₱1,850.00</div>
            </div>
            <div class="card card-savings">
                <h3 style="color: var(--accent-brown)">Savings Goal</h3>
                <div class="amount" style="color: var(--accent-brown)">₱5,000 / ₱10k</div>
            </div>
        </div>

        <div class="recent-transactions">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 class="section-title">Transactions ([[ targetMonth ]])</h2>
                <button class="btn-primary" @click="addNew">+ Add Transaction</button>
            </div>

            <div v-if="showForm" class="modal-backdrop" @click.self="showForm = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 15px; color: var(--navy-contrast);">Add New Transaction</h3>
                    
                    <div class="form-group">
                        <input type="date" v-model="newTransaction.date" required>
                        <input type="text" v-model="newTransaction.name" placeholder="Name">
                        
                        <select v-model="newTransaction.category">
                            <option disabled value="">Select Category</option>
                            <option v-for="cat in categories" :value="cat.id">
                                [[ cat.name ]] ([[ cat.type ]])
                            </option>
                        </select>
                        
                        <input type="number" step="0.01" v-model="newTransaction.amount" placeholder="Amount (₱)">
                    </div>

                    <div class="modal-actions">
                        <button class="btn-cancel" @click="showForm = false">Cancel</button>
                        <button class="btn-primary" @click="submitTransaction">Save</button>
                    </div>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th style="text-align: right;">Amount</th>
                        <th style="text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="t in filteredTransactions" :key="t.id">
                        <td>[[ formatDate(t.date) ]]</td>
                        <td>[[ t.name ]]</td>
                        <td>[[ t.category ]]</td>
                        
                        <td :class="t.type === 'INCOME' ? 'money-plus' : 'money-minus'" style="text-align: right;">
                            [[ t.type === 'INCOME' ? '+' : '-' ]]₱[[ t.amount.toFixed(2) ]]
                        </td>

                        <td style="text-align: center;">
                            <button class="action-btn btn-edit" @click="editTransaction(t.id)">Edit</button>
                            <button class="action-btn btn-delete" @click="deleteTransaction(t.id)">Delete</button>
                        </td>
                    </tr>

                    <tr v-if="filteredTransactions.length === 0">
                        <td colspan="5" class="no-data">No transactions found for [[ targetMonth ]]</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const { createApp } = Vue;

    createApp({
        delimiters: ['[[', ']]'],
        data() {
            const now = new Date();
            const displayDate = now.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long'
            });

            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const filterDate = `${year}-${month}`; 

            return {
                showForm: false,
                targetMonth: displayDate,
                filterKey: filterDate,
                transactions: [],
                // Ensure this template tag is rendered by Django before Vue sees it
                categories: {{ categories|safe }},
                newTransaction: {
                    date: new Date().toISOString().split('T')[0],
                    name: '',
                    category: '',
                    amount: ''
                }
            }
        },
        computed: {
            filteredTransactions() {
                return this.transactions.filter(t => t.date.startsWith(this.filterKey));
            }
        },
        methods: {
            addNew() {
                this.showForm = !this.showForm;
            },
            formatDate(dateStr) {
                const options = { year: 'numeric', month: 'short', day: '2-digit' };
                return new Date(dateStr).toLocaleDateString('en-US', options);
            },
            async deleteTransaction(id) {
                if(confirm("Are you sure you want to delete this transaction?")) {
                    const csrftoken = document.cookie.split('; ')
                        .find(row => row.startsWith('csrftoken='))
                        ?.split('=')[1];

                    try {
                        const response = await fetch(`/delete-transaction/${id}/`, {
                            method: 'DELETE',
                            headers: {
                                'X-CSRFToken': csrftoken,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (response.ok) {
                            this.transactions = this.transactions.filter(t => t.id !== id);
                            console.log("Transaction deleted from database");
                        } else {
                            alert("Failed to delete transaction.");
                        }
                    } catch (error) {
                        console.error("Error deleting:", error);
                    }
                }
            },
            async submitTransaction() {
                const csrftoken = document.cookie.split('; ')
                    .find(row => row.startsWith('csrftoken='))
                    ?.split('=')[1];

                try {
                    const response = await fetch('/add-transaction/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify(this.newTransaction)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        alert('Transaction Saved!');
                        this.fetchTransactions();
                        this.newTransaction.name = '';
                        this.newTransaction.amount = '';
                        this.showForm = false; 
                    } else {
                        console.error("Errors:", data.errors);
                        alert("Error saving transaction. Check console.");
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            },
            async fetchTransactions() {
                try {
                    const response = await fetch('/api/transactions/');
                    const data = await response.json();
                    this.transactions = data;
                } catch (error) {
                    console.error("Error loading transactions:", error);
                }
            }
        },
        mounted() {
            this.fetchTransactions();
        }
    }).mount('#app');
</script>
{% endblock %}