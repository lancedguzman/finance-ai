{% extends 'base.html' %}

{% block content %}
<div id="app">
    <div class="container">
        
        <div class="header-section">
            <h1>Welcome Back, {{ request.user }}!</h1>
            <p style="color: var(--accent-brown);">Here is your financial overview for [[ targetMonth ]].</p>
        </div>

        <div class="cards-grid">
            <div class="card card-balance">
                <h3>Total Balance (Month)</h3>
                <div class="amount">[[ formatCurrency(monthlyBalance) ]]</div>
            </div>
            <div class="card card-income">
                <h3 style="color: var(--text-green)">Monthly Income</h3>
                <div class="amount" style="color: var(--text-green)">+[[ formatCurrency(monthlyIncome) ]]</div>
            </div>
            <div class="card card-expense">
                <h3>Monthly Expenses</h3>
                <div class="amount" style="color: var(--alert-red)">-[[ formatCurrency(monthlyExpense) ]]</div>
            </div>
            <div class="card card-savings">
                <h3 style="color: var(--accent-brown)">Savings Goal (40%)</h3>
                <div class="amount" style="color: var(--accent-brown)">
                    [[ formatCurrency(monthlySavings) ]] / [[ formatCurrency(savingsGoal) ]]
                </div>
            </div>
        </div>

        <div class="recent-transactions">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px;">
                
                <div style="display: flex; align-items: center; gap: 15px;">
                    <h2 class="section-title" style="margin-bottom:0; border:none;">Transactions</h2>
                    
                    <select v-model="filterKey" style="padding: 5px 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; color: var(--navy-contrast); cursor: pointer;">
                        <option v-for="m in monthOptions" :value="m.value">
                            [[ m.label ]]
                        </option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn-primary" style="background-color: var(--accent-brown);" @click="toggleCategoryModal">
                        + Add Category
                    </button>
                    <button class="btn-primary" @click="addNew">+ Add Transaction</button>
                </div>
            </div>

            <div style="border-bottom: 2px solid var(--bg-body); margin-top: 10px; margin-bottom: 1rem;"></div>

            <div v-if="showForm" class="modal-backdrop" @click.self="showForm = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 15px; color: var(--navy-contrast);">Add New Transaction</h3>
                    <div class="form-group">
                        <input type="date" v-model="newTransaction.date" required>
                        <input type="text" v-model="newTransaction.name" placeholder="Name">
                        <select v-model="newTransaction.category">
                            <option disabled value="">Select Category</option>
                            <option v-for="cat in categories" :value="cat.id">
                                [[ cat.name ]] ([[ cat.type ]])
                            </option>
                        </select>
                        <input type="number" step="0.01" v-model="newTransaction.amount" placeholder="Amount (₱)">
                    </div>
                    <div class="modal-actions">
                        <button class="btn-cancel" @click="showForm = false">Cancel</button>
                        <button class="btn-primary" @click="submitTransaction">Save</button>
                    </div>
                </div>
            </div>

            <div v-if="showCategoryForm" class="modal-backdrop" @click.self="showCategoryForm = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 15px; color: var(--navy-contrast);">Add New Category</h3>
                    <div class="form-group">
                        <label style="font-size: 0.9rem; color: #666;">Category Name</label>
                        <input type="text" v-model="newCategory.name" placeholder="e.g. Groceries, Crypto, Bonus">
                        <label style="font-size: 0.9rem; color: #666;">Type</label>
                        <select v-model="newCategory.type">
                            <option value="EXPENSE">Expense</option>
                            <option value="INCOME">Income</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-cancel" @click="showCategoryForm = false">Cancel</button>
                        <button class="btn-primary" @click="submitCategory">Create Category</button>
                    </div>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th style="text-align: right;">Amount</th>
                        <th style="text-align: center;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="t in filteredTransactions" :key="t.id">
                        <td>[[ formatDate(t.date) ]]</td>
                        <td>[[ t.name ]]</td>
                        <td>[[ t.category ]]</td>
                        <td :class="t.type === 'INCOME' ? 'money-plus' : 'money-minus'" style="text-align: right;">
                            [[ t.type === 'INCOME' ? '+' : '-' ]]₱[[ t.amount.toFixed(2) ]]
                        </td>
                        <td style="text-align: center;">
                            <button class="action-btn btn-edit" @click="editTransaction(t.id)">Edit</button>
                            <button class="action-btn btn-delete" @click="deleteTransaction(t.id)">Delete</button>
                        </td>
                    </tr>
                    <tr v-if="filteredTransactions.length === 0">
                        <td colspan="5" class="no-data">No transactions found for [[ targetMonth ]]</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const { createApp } = Vue;

    createApp({
        delimiters: ['[[', ']]'],
        data() {
            const now = new Date();
            // Default filterKey is current "YYYY-MM"
            const currentKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            return {
                showForm: false,
                showCategoryForm: false,
                filterKey: currentKey, // Controls the dropdown
                transactions: [],
                categories: {{ categories|safe }},
                
                newTransaction: {
                    date: new Date().toISOString().split('T')[0],
                    name: '',
                    category: '',
                    amount: ''
                },
                newCategory: {
                    name: '',
                    type: 'EXPENSE'
                }
            }
        },
        computed: {
            // 1. Dynamic Month Label (e.g., "December 2025")
            targetMonth() {
                if (!this.filterKey) return '';
                const [year, month] = this.filterKey.split('-');
                const date = new Date(year, month - 1);
                return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            },

            // 2. Generate Dropdown Options (Past 12 months + Next 12 months + Transaction months)
            monthOptions() {
                const options = [];
                const now = new Date();
                
                // Add range: 12 months back and 12 months forward
                for (let i = -12; i <= 12; i++) {
                    const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const key = `${y}-${m}`;
                    const label = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    options.push({ value: key, label: label });
                }

                // Add any months from transactions that are outside the range
                this.transactions.forEach(t => {
                    const key = t.date.substring(0, 7); // YYYY-MM
                    if (!options.find(o => o.value === key)) {
                        const [y, m] = key.split('-');
                        const d = new Date(y, m - 1);
                        const label = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                        options.push({ value: key, label: label });
                    }
                });

                // Sort descending (Newest first)
                return options.sort((a, b) => b.value.localeCompare(a.value));
            },

            // 3. Filter Transactions based on Dropdown
            filteredTransactions() {
                return this.transactions.filter(t => t.date.startsWith(this.filterKey));
            },

            // 4. Calculations (Automatically update based on filteredTransactions)
            monthlyIncome() {
                return this.filteredTransactions.filter(t => t.type === 'INCOME').reduce((sum, t) => sum + t.amount, 0);
            },
            monthlyExpense() {
                return this.filteredTransactions.filter(t => t.type === 'EXPENSE').reduce((sum, t) => sum + t.amount, 0);
            },
            monthlyBalance() {
                return this.monthlyIncome - this.monthlyExpense;
            },
            savingsGoal() {
                return this.monthlyIncome * 0.40;
            },
            monthlySavings() {
                const savings = this.monthlyIncome - this.monthlyExpense;
                return savings > 0 ? savings : 0;
            }
        },
        methods: {
            addNew() { this.showForm = !this.showForm; },
            toggleCategoryModal() { this.showCategoryForm = !this.showCategoryForm; },
            
            formatDate(dateStr) {
                const options = { year: 'numeric', month: 'short', day: '2-digit' };
                return new Date(dateStr).toLocaleDateString('en-US', options);
            },
            formatCurrency(value) {
                return '₱' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            },

            async submitCategory() {
                const csrftoken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                try {
                    const response = await fetch('/add-category/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                        body: JSON.stringify(this.newCategory)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert('Category Created!');
                        this.categories.push(data.category);
                        this.newCategory.name = '';
                        this.showCategoryForm = false;
                    } else {
                        alert(data.error || "Error creating category");
                    }
                } catch (error) { console.error('Error:', error); }
            },

            async deleteTransaction(id) {
                if(confirm("Are you sure you want to delete this transaction?")) {
                    const csrftoken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                    try {
                        const response = await fetch(`/delete-transaction/${id}/`, {
                            method: 'DELETE',
                            headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' }
                        });
                        if (response.ok) {
                            this.transactions = this.transactions.filter(t => t.id !== id);
                        } else {
                            alert("Failed to delete transaction.");
                        }
                    } catch (error) { console.error("Error deleting:", error); }
                }
            },
            async submitTransaction() {
                const csrftoken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                try {
                    const response = await fetch('/add-transaction/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                        body: JSON.stringify(this.newTransaction)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert('Transaction Saved!');
                        this.fetchTransactions();
                        this.newTransaction.name = '';
                        this.newTransaction.amount = '';
                        this.showForm = false; 
                    } else {
                        console.error("Errors:", data.errors);
                        alert("Error saving transaction.");
                    }
                } catch (error) { console.error('Error:', error); }
            },
            async fetchTransactions() {
                try {
                    const response = await fetch('/api/transactions/');
                    const data = await response.json();
                    this.transactions = data;
                } catch (error) { console.error("Error loading transactions:", error); }
            }
        },
        mounted() {
            this.fetchTransactions();
        }
    }).mount('#app');
</script>
{% endblock %}