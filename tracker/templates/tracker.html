{% extends 'base.html' %}

{% block content %}
<style>
    /* LOCAL STYLES FOR TRACKER */
    
    /* Table Wrapper: Essential for Mobile */
    .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
        margin-top: 1rem;
        border-radius: 8px;
    }
    
    /* Force table to keep shape inside wrapper */
    table { min-width: 600px; }

    /* Header Controls */
    .tracker-header {
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        flex-wrap: wrap; /* Allows wrapping on iPhone */
        gap: 15px;
    }

    .tracker-controls {
        display: flex; 
        gap: 10px;
        flex-wrap: wrap;
    }

    /* Mobile specific tweaks */
    @media (max-width: 768px) {
        .tracker-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .tracker-title-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .tracker-controls {
            width: 100%;
        }

        .tracker-controls button {
            flex: 1; /* Buttons stretch to fill width */
            justify-content: center;
            white-space: nowrap;
        }
        
        /* Stop iOS zooming on inputs */
        input, select { font-size: 16px !important; }
    }
</style>

<div id="app">
    <div class="container">
        
        <div class="header-section">
            <h1>Welcome Back, {{ request.user }}!</h1>
            <p style="color: var(--accent-brown);">Here is your financial overview for [[ targetMonth ]].</p>
        </div>

        <div class="cards-grid">
            <div class="card card-balance">
                <h3>Total Balance (Month)</h3>
                <div class="amount">[[ formatCurrency(monthlyBalance) ]]</div>
            </div>
            <div class="card card-income">
                <h3 style="color: var(--text-green)">Monthly Income</h3>
                <div class="amount" style="color: var(--text-green)">+[[ formatCurrency(monthlyIncome) ]]</div>
            </div>
            <div class="card card-expense">
                <h3>Monthly Expenses</h3>
                <div class="amount" style="color: var(--alert-red)">-[[ formatCurrency(monthlyExpense) ]]</div>
            </div>
            <div class="card card-savings">
                <h3 style="color: var(--accent-brown)">Savings Goal (40%)</h3>
                <div class="amount" style="color: var(--accent-brown)">
                    [[ formatCurrency(monthlySavings) ]] / [[ formatCurrency(savingsGoal) ]]
                </div>
            </div>
        </div>

        <div class="recent-transactions">
            <div class="tracker-header">
                
                <div class="tracker-title-group" style="display: flex; align-items: center; gap: 15px;">
                    <h2 class="section-title" style="margin-bottom:0; border:none;">Transactions</h2>
                    
                    <select v-model="filterKey" style="padding: 5px 10px; border-radius: 6px; border: 1px solid #ccc; font-size: 1rem; color: var(--navy-contrast); cursor: pointer;">
                        <option v-for="m in monthOptions" :value="m.value">
                            [[ m.label ]]
                        </option>
                    </select>
                </div>
                
                <div class="tracker-controls">
                    <button class="btn-primary" style="background-color: var(--accent-brown);" @click="toggleCategoryModal">
                        + Cat
                    </button>
                    <button class="btn-primary" @click="addNew">+ Add</button>
                    <button class="btn-primary" style="background-color: #0d6efd;" @click="showUploadModal = true">
                        + Upload
                    </button>
                </div>
            </div>

            <div style="border-bottom: 2px solid var(--bg-body); margin-top: 10px; margin-bottom: 1rem;"></div>

            <div v-if="showForm" class="modal-backdrop" @click.self="showForm = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 15px; color: var(--navy-contrast);">Add New Transaction</h3>
                    <div class="form-group">
                        <input type="date" v-model="newTransaction.date" required>
                        <input type="text" v-model="newTransaction.name" placeholder="Name">
                        <select v-model="newTransaction.category">
                            <option disabled value="">Select Category</option>
                            <option v-for="cat in categories" :value="cat.id">
                                [[ cat.name ]] ([[ cat.type ]])
                            </option>
                        </select>
                        <input type="number" step="0.01" v-model="newTransaction.amount" placeholder="Amount (₱)">
                    </div>
                    <div class="modal-actions">
                        <button class="btn-cancel" @click="showForm = false">Cancel</button>
                        <button class="btn-primary" @click="submitTransaction">Save</button>
                    </div>
                </div>
            </div>

            <div v-if="showCategoryForm" class="modal-backdrop" @click.self="showCategoryForm = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 15px; color: var(--navy-contrast);">Add New Category</h3>
                    <div class="form-group">
                        <label style="font-size: 0.9rem; color: #666;">Category Name</label>
                        <input type="text" v-model="newCategory.name" placeholder="e.g. Groceries">
                        <label style="font-size: 0.9rem; color: #666;">Type</label>
                        <select v-model="newCategory.type">
                            <option value="EXPENSE">Expense</option>
                            <option value="INCOME">Income</option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-cancel" @click="showCategoryForm = false">Cancel</button>
                        <button class="btn-primary" @click="submitCategory">Create</button>
                    </div>
                </div>
            </div>

            <div v-if="showForm" class="modal-backdrop" @click.self="closeForm">
                <div class="modal-content">
                    <h3 style="margin-bottom: 15px; color: var(--navy-contrast);">
                        [[ isEditing ? 'Edit Transaction' : 'Add New Transaction' ]]
                    </h3>
                    <div class="form-group">
                        <input type="date" v-model="newTransaction.date" required>
                        <input type="text" v-model="newTransaction.name" placeholder="Name">
                        <select v-model="newTransaction.category">
                            <option disabled value="">Select Category</option>
                            <option v-for="cat in categories" :value="cat.id">
                                [[ cat.name ]] ([[ cat.type ]])
                            </option>
                        </select>
                        <input type="number" step="0.01" v-model="newTransaction.amount" placeholder="Amount (₱)">
                    </div>
                    <div class="modal-actions">
                        <button class="btn-cancel" @click="closeForm">Cancel</button>
                        <button class="btn-primary" @click="submitTransaction">
                            [[ isEditing ? 'Update' : 'Save' ]]
                        </button>
                    </div>
                </div>
            </div>

            <div v-if="showUploadModal" class="modal-backdrop" @click.self="showUploadModal = false">
                <div class="modal-content">
                    <h3 style="margin-bottom: 1rem;">Upload Receipt</h3>
                    <div class="form-group">
                        <label>1. Select Image</label>
                        <input type="file" ref="smartFileInput" accept="image/*" @change="handleFileSelect">
                    </div>
                    <div class="form-group">
                        <label>2. Name</label>
                        <input type="text" v-model="uploadData.name" placeholder="e.g. Coffee">
                    </div>
                    <div class="form-group">
                        <label>3. Category</label>
                        <select v-model="uploadData.category">
                            <option disabled value="">Select Category</option>
                            <option v-for="cat in categories" :value="cat.id">
                                [[ cat.name ]] ([[ cat.type ]])
                            </option>
                        </select>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-cancel" @click="showUploadModal = false">Cancel</button>
                        <button class="btn-primary" @click="processSmartUpload" :disabled="isScanning">
                            [[ isScanning ? 'Scanning...' : 'Next' ]]
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th style="text-align: right;">Amount</th>
                            <th style="text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="t in filteredTransactions" :key="t.id">
                            <td style="white-space: nowrap;">[[ formatDate(t.date) ]]</td>
                            <td>[[ t.name ]]</td>
                            <td>[[ t.category ]]</td>
                            <td :class="t.type === 'INCOME' ? 'money-plus' : 'money-minus'" style="text-align: right; white-space: nowrap;">
                                [[ t.type === 'INCOME' ? '+' : '-' ]]₱[[ t.amount.toFixed(2) ]]
                            </td>
                            <td style="text-align: center; white-space: nowrap;">
                                <button class="action-btn btn-edit" @click="editTransaction(t.id)">Edit</button>
                                <button class="action-btn btn-delete" @click="deleteTransaction(t.id)">Del</button>
                            </td>
                        </tr>
                        <tr v-if="filteredTransactions.length === 0">
                            <td colspan="5" class="no-data">No transactions found for [[ targetMonth ]]</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Existing script logic preserved exactly as is
    const { createApp } = Vue;

    createApp({
        delimiters: ['[[', ']]'],
        data() {
            const now = new Date();
            const currentKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            return {
                showForm: false, showCategoryForm: false, showUploadModal: false, isScanning: false,
                uploadData: { file: null, name: '', category: '' }, filterKey: currentKey,
                transactions: [], categories: {{ categories|safe }}, isEditing: false, editingId: null,
                newTransaction: { date: new Date().toISOString().split('T')[0], name: '', category: '', amount: '' },
                newCategory: { name: '', type: 'EXPENSE' }
            }
        },
        computed: {
            targetMonth() {
                if (!this.filterKey) return '';
                const [year, month] = this.filterKey.split('-');
                const date = new Date(year, month - 1);
                return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            },
            monthOptions() {
                const options = [];
                const now = new Date();
                for (let i = -12; i <= 12; i++) {
                    const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const key = `${y}-${m}`;
                    const label = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    options.push({ value: key, label: label });
                }
                this.transactions.forEach(t => {
                    const key = t.date.substring(0, 7);
                    if (!options.find(o => o.value === key)) {
                        const [y, m] = key.split('-');
                        const d = new Date(y, m - 1);
                        const label = d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                        options.push({ value: key, label: label });
                    }
                });
                return options.sort((a, b) => b.value.localeCompare(a.value));
            },
            filteredTransactions() { return this.transactions.filter(t => t.date.startsWith(this.filterKey)); },
            monthlyIncome() { return this.filteredTransactions.filter(t => t.type === 'INCOME').reduce((sum, t) => sum + t.amount, 0); },
            monthlyExpense() { return this.filteredTransactions.filter(t => t.type === 'EXPENSE').reduce((sum, t) => sum + t.amount, 0); },
            monthlyBalance() { return this.monthlyIncome - this.monthlyExpense; },
            savingsGoal() { return this.monthlyIncome * 0.40; },
            monthlySavings() { const savings = this.monthlyIncome - this.monthlyExpense; return savings > 0 ? savings : 0; }
        },
        methods: {
            addNew() { this.resetForm(); this.isEditing = false; this.showForm = true; },
            resetForm() { this.newTransaction = { date: new Date().toISOString().split('T')[0], name: '', category: '', amount: '' }; this.editingId = null; },
            closeForm() { this.showForm = false; this.resetForm(); this.isEditing = false; },
            editTransaction(id) {
                const t = this.transactions.find(item => item.id === id);
                if (t) {
                    this.newTransaction = { date: t.date, name: t.name, category: t.category_id, amount: t.amount };
                    this.editingId = id; this.isEditing = true; this.showForm = true;
                }
            },
            toggleCategoryModal() { this.showCategoryForm = !this.showCategoryForm; },
            formatDate(dateStr) { const options = { year: 'numeric', month: 'short', day: '2-digit' }; return new Date(dateStr).toLocaleDateString('en-US', options); },
            formatCurrency(value) { return '₱' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); },
            handleFileSelect(event) { this.uploadData.file = event.target.files[0]; },
            async processSmartUpload() {
                if (!this.uploadData.file || !this.uploadData.category) { alert("Please select image and category."); return; }
                this.isScanning = true;
                const formData = new FormData();
                formData.append('receipt_image', this.uploadData.file);
                const csrftoken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                try {
                    const res = await fetch('/scanner/api/process/', { method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: formData });
                    const result = await res.json();
                    if (res.ok) {
                        this.showUploadModal = false;
                        this.newTransaction = {
                            date: result.data.date || new Date().toISOString().split('T')[0],
                            name: this.uploadData.name || "Scanned Receipt",
                            category: this.uploadData.category,
                            amount: result.data.amount || ''
                        };
                        this.showForm = true; this.uploadData = { file: null, name: '', category: '' };
                        if(this.$refs.smartFileInput) this.$refs.smartFileInput.value = '';
                    } else { alert(result.error || "Scan failed."); }
                } catch (e) { alert("Connection error."); } finally { this.isScanning = false; }
            },
            async submitCategory() {
                const csrftoken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                try {
                    const response = await fetch('/add-category/', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }, body: JSON.stringify(this.newCategory) });
                    const data = await response.json();
                    if (response.ok) { alert('Category Created!'); this.categories.push(data.category); this.newCategory.name = ''; this.showCategoryForm = false; } else { alert(data.error || "Error creating category"); }
                } catch (error) { console.error('Error:', error); }
            },
            async deleteTransaction(id) {
                if(confirm("Are you sure you want to delete this transaction?")) {
                    const csrftoken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                    try {
                        const response = await fetch(`/delete-transaction/${id}/`, { method: 'DELETE', headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' } });
                        if (response.ok) { this.transactions = this.transactions.filter(t => t.id !== id); } else { alert("Failed to delete transaction."); }
                    } catch (error) { console.error("Error deleting:", error); }
                }
            },
            async submitTransaction() {
                const csrftoken = document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
                let url = '/add-transaction/'; let method = 'POST';
                if (this.isEditing) { url = `/edit-transaction/${this.editingId}/`; method = 'PUT'; }
                try {
                    const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken }, body: JSON.stringify(this.newTransaction) });
                    const data = await response.json();
                    if (response.ok) { alert(this.isEditing ? 'Transaction Updated!' : 'Transaction Saved!'); this.fetchTransactions(); this.closeForm(); } else { console.error("Errors:", data.errors); alert("Error saving transaction."); }
                } catch (error) { console.error('Error:', error); }
            },
            async fetchTransactions() {
                try { const response = await fetch('/api/transactions/'); const data = await response.json(); this.transactions = data; } catch (error) { console.error("Error loading transactions:", error); }
            }
        },
        mounted() { this.fetchTransactions(); }
    }).mount('#app');
</script>
{% endblock %}